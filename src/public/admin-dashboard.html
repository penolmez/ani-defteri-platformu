<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - SipariÅŸ YÃ¶netimi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">
    <!-- Header -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-black text-slate-800">ğŸ“¦ SipariÅŸ YÃ¶netimi</h1>
                <div class="flex items-center gap-4">
                    <div id="stats" class="text-sm text-slate-600"></div>
                    <button onclick="loadOrders()"
                        class="px-4 py-2 bg-slate-600 text-white rounded-lg font-bold hover:bg-slate-700 transition">
                        ğŸ”„ Yenile
                    </button>
                    <a href="/admin"
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 transition">
                        ğŸ“² Token OluÅŸtur
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Filters & Bulk Actions -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 flex gap-4 items-center flex-wrap">
            <label class="font-semibold text-slate-700">Filtrele:</label>
            <select id="statusFilter" onchange="filterOrders()" class="px-4 py-2 border border-slate-200 rounded-lg">
                <option value="all">TÃ¼m Durumlar</option>
                <option value="submitted">GÃ¶nderildi</option>
                <option value="psd_done">PSD HazÄ±r</option>
                <option value="preview_sent">Ã–nizleme GÃ¶nderildi</option>
                <option value="approved">OnaylandÄ±</option>
                <option value="print_done">BasÄ±m Bitti</option>
            </select>
            <input type="text" id="searchInput" placeholder="MÃ¼ÅŸteri veya sipariÅŸ ID ara..." onkeyup="filterOrders()"
                class="flex-1 min-w-[200px] px-4 py-2 border border-slate-200 rounded-lg">
        </div>

        <!-- Bulk Actions Toolbar (shows when items selected) -->
        <div id="bulkActionsBar"
            class="hidden bg-orange-50 border-2 border-orange-300 rounded-xl shadow-md p-4 mb-6 flex gap-4 items-center flex-wrap">
            <span class="font-bold text-orange-800" id="selectedCount">0 sipariÅŸ seÃ§ildi</span>
            <select id="bulkStatus" class="px-4 py-2 border-2 border-orange-200 rounded-lg bg-white">
                <option value="">Durum SeÃ§...</option>
                <option value="submitted">ğŸ“¤ GÃ¶nderildi</option>
                <option value="psd_done">ğŸ¨ PSD HazÄ±r</option>
                <option value="preview_sent">ğŸ‘ï¸ Ã–nizleme GÃ¶nderildi</option>
                <option value="approved">âœ… OnaylandÄ±</option>
                <option value="print_done">ğŸ–¨ï¸ BasÄ±m Bitti</option>
            </select>
            <button onclick="applyBulkUpdate()"
                class="px-6 py-2 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 transition shadow-md">
                âœ¨ SeÃ§ililere Uygula
            </button>
            <button onclick="clearSelection()"
                class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300 transition">
                âœ– SeÃ§imi Temizle
            </button>
        </div>

        <!-- Orders Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-slate-100 border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3 text-center w-12">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()"
                                    class="w-4 h-4 cursor-pointer">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">SipariÅŸ ID</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">MÃ¼ÅŸteri</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Tarih</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Durum</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Dosyalar</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-slate-600 uppercase">Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTable">
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-slate-400">
                                <div class="text-4xl mb-2">â³</div>
                                <p>SipariÅŸler yÃ¼kleniyor...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Status Update Modal -->
    <div id="statusModal" class="hidden fixed inset-0 bg-slate-900/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Durum GÃ¼ncelle</h3>
            <div id="modalOrderInfo" class="mb-4 p-3 bg-slate-50 rounded-lg text-sm"></div>

            <label class="block text-sm font-semibold text-slate-700 mb-2">Yeni Durum:</label>
            <select id="newStatus" class="w-full px-4 py-2 border border-slate-200 rounded-lg mb-4">
                <option value="submitted">ğŸ“¤ GÃ¶nderildi</option>
                <option value="psd_done">ğŸ¨ PSD HazÄ±r</option>
                <option value="preview_sent">ğŸ‘ï¸ Ã–nizleme GÃ¶nderildi</option>
                <option value="approved">âœ… OnaylandÄ±</option>
                <option value="print_done">ğŸ–¨ï¸ Basim Bitti</option>
            </select>

            <label class="block text-sm font-semibold text-slate-700 mb-2">Not (Opsiyonel):</label>
            <textarea id="statusNote" rows="3"
                class="w-full px-4 py-2 border border-slate-200 rounded-lg mb-4 resize-none"
                placeholder="Durum deÄŸiÅŸikliÄŸi hakkÄ±nda not..."></textarea>

            <div class="flex gap-3">
                <button onclick="closeStatusModal()"
                    class="flex-1 px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300">
                    Ä°ptal
                </button>
                <button onclick="saveStatus()"
                    class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700">
                    Kaydet
                </button>
            </div>
        </div>
    </div>

    <script>
        let allOrders = [];
        let currentOrderId = null;
        let selectedOrders = new Set();

        async function loadOrders() {
            try {
                const res = await fetch('/api/admin/orders');
                const result = await res.json();

                if (result.success) {
                    allOrders = result.orders;
                    renderOrders(allOrders);
                    updateStats(allOrders);
                } else {
                    alert('SipariÅŸler yÃ¼klenemedi: ' + result.error);
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersTable').innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-red-500">
                            <div class="text-4xl mb-2">âŒ</div>
                            <p>SipariÅŸler yÃ¼klenirken hata oluÅŸtu.</p>
                            <p class="text-sm mt-2">${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderOrders(orders) {
            const table = document.getElementById('ordersTable');

            if (orders.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-8 text-center text-slate-400">
                            <div class="text-4xl mb-2">ğŸ“­</div>
                            <p>SipariÅŸ bulunamadÄ±.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            table.innerHTML = orders.map(order => {
                const isSelected = selectedOrders.has(order.orderId);
                return `
                <tr class="border-b border-slate-100 hover:bg-slate-50 transition ${isSelected ? 'bg-blue-50' : ''}">
                    <td class="px-4 py-3 text-center">
                        <input type="checkbox" class="order-checkbox w-4 h-4 cursor-pointer" 
                            data-order-id="${order.orderId}" 
                            ${isSelected ? 'checked' : ''}
                            onchange="toggleOrderSelection('${order.orderId}')">
                    </td>
                    <td class="px-4 py-3">
                        <code class="text-xs font-mono text-slate-700 bg-slate-100 px-2 py-1 rounded">${order.orderId}</code>
                    </td>
                    <td class="px-4 py-3 font-semibold text-slate-800">${order.customerName}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">
                        ${new Date(order.createdAt).toLocaleDateString('tr-TR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}
                    </td>
                    <td class="px-4 py-3">
                        ${getStatusBadge(order.status)}
                    </td>
                    <td class="px-4 py-3 text-xs text-slate-600">
                        ${formatFileCounts(order.fileCounts || {})}
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex gap-2">
                            <button onclick='openStatusModal(${JSON.stringify(order.orderId)}, ${JSON.stringify(order.customerName)}, ${JSON.stringify(order.status)})'
                                    class="px-3 py-1 bg-blue-600 text-white rounded text-xs font-bold hover:bg-blue-700 transition whitespace-nowrap">
                                âœï¸ Durum
                            </button>
                            <a href="${order.driveLink}" target="_blank"
                               class="px-3 py-1 bg-green-600 text-white rounded text-xs font-bold hover:bg-green-700 transition whitespace-nowrap">
                                â˜ï¸ Drive
                            </a>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        function getStatusBadge(status) {
            const badges = {
                'submitted': '<span class="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-800 whitespace-nowrap">ğŸ“¤ GÃ¶nderildi</span>',
                'psd_done': '<span class="px-3 py-1 rounded-full text-xs font-bold bg-purple-100 text-purple-800 whitespace-nowrap">ğŸ¨ PSD HazÄ±r</span>',
                'preview_sent': '<span class="px-3 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-800 whitespace-nowrap">ğŸ‘ï¸ Ã–nizleme</span>',
                'approved': '<span class="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800 whitespace-nowrap">âœ… OnaylandÄ±</span>',
                'print_done': '<span class="px-3 py-1 rounded-full text-xs font-bold bg-emerald-100 text-emerald-800 whitespace-nowrap">ğŸ–¨ï¸ BasÄ±m Bitti</span>'
            };
            return badges[status] || badges['submitted'];
        }

        function formatFileCounts(counts) {
            const entries = Object.entries(counts);
            if (entries.length === 0) return '-';
            return entries.map(([folder, count]) =>
                `<span class="inline-block mr-2">${folder}: <strong>${count}</strong></span>`
            ).join('');
        }

        function updateStats(orders) {
            const stats = {
                total: orders.length,
                submitted: orders.filter(o => o.status === 'submitted').length,
                inProgress: orders.filter(o => ['psd_done', 'preview_sent'].includes(o.status)).length,
                completed: orders.filter(o => ['approved', 'print_done'].includes(o.status)).length
            };

            document.getElementById('stats').innerHTML = `
                Toplam: <strong>${stats.total}</strong> | 
                Yeni: <strong class="text-blue-600">${stats.submitted}</strong> | 
                Ä°ÅŸlemde: <strong class="text-orange-600">${stats.inProgress}</strong> | 
                TamamlandÄ±: <strong class="text-green-600">${stats.completed}</strong>
            `;
        }

        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            let filtered = allOrders;

            if (statusFilter !== 'all') {
                filtered = filtered.filter(o => o.status === statusFilter);
            }

            if (searchText) {
                filtered = filtered.filter(o =>
                    o.customerName.toLowerCase().includes(searchText) ||
                    o.orderId.toLowerCase().includes(searchText)
                );
            }

            renderOrders(filtered);
            updateStats(filtered);
        }

        function openStatusModal(orderId, customerName, currentStatus) {
            currentOrderId = orderId;
            document.getElementById('modalOrderInfo').innerHTML = `
                <strong>SipariÅŸ:</strong> <code class="bg-slate-200 px-2 py-1 rounded text-xs">${orderId}</code><br>
                <strong>MÃ¼ÅŸteri:</strong> ${customerName}<br>
                <strong>Mevcut Durum:</strong> ${getStatusBadge(currentStatus)}
            `;
            document.getElementById('newStatus').value = currentStatus;
            document.getElementById('statusNote').value = '';
            document.getElementById('statusModal').classList.remove('hidden');
        }

        function closeStatusModal() {
            document.getElementById('statusModal').classList.add('hidden');
            currentOrderId = null;
        }

        async function saveStatus() {
            const newStatus = document.getElementById('newStatus').value;
            const note = document.getElementById('statusNote').value;

            try {
                const res = await fetch(`/api/admin/orders/${currentOrderId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus, note })
                });

                const result = await res.json();

                if (result.success) {
                    alert(`âœ… Durum gÃ¼ncellendi!\n\n${result.oldStatus} â†’ ${result.newStatus}`);
                    closeStatusModal();
                    loadOrders();
                } else {
                    alert('âŒ Hata: ' + result.error);
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert(' âŒ Durum gÃ¼ncellenirken hata oluÅŸtu: ' + error.message);
            }
        }

        // Close modal when clicking outside
        document.getElementById('statusModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('statusModal')) {
                closeStatusModal();
            }
        });

        // Toggle order selection
        function toggleOrderSelection(orderId) {
            if (selectedOrders.has(orderId)) {
                selectedOrders.delete(orderId);
            } else {
                selectedOrders.add(orderId);
            }
            updateBulkActionsBar();
            renderOrders(allOrders); // Re-render to update checkbox states and row colors
        }

        // Toggle select all
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox.checked) {
                // Select all visible orders
                const visibleOrders = Array.from(document.querySelectorAll('.order-checkbox'));
                visibleOrders.forEach(cb => {
                    const orderId = cb.getAttribute('data-order-id');
                    selectedOrders.add(orderId);
                });
            } else {
                // Clear all selections
                selectedOrders.clear();
            }
            updateBulkActionsBar();
            renderOrders(allOrders);
        }

        // Clear selection
        function clearSelection() {
            selectedOrders.clear();
            document.getElementById('selectAll').checked = false;
            updateBulkActionsBar();
            renderOrders(allOrders);
        }

        // Update bulk actions bar visibility and count
        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActionsBar');
            const count = document.getElementById('selectedCount');

            if (selectedOrders.size > 0) {
                bar.classList.remove('hidden');
                count.textContent = `${selectedOrders.size} sipariÅŸ seÃ§ildi`;
            } else {
                bar.classList.add('hidden');
            }
        }

        // Apply bulk status update
        async function applyBulkUpdate() {
            const newStatus = document.getElementById('bulkStatus').value;

            if (!newStatus) {
                alert('âš ï¸ LÃ¼tfen bir durum seÃ§in!');
                return;
            }

            const note = prompt(`${selectedOrders.size} sipariÅŸ iÃ§in toplu gÃ¼ncelleme yapÄ±lacak.\n\nÄ°steÄŸe baÄŸlÄ± not girin (veya boÅŸ bÄ±rakÄ±n):`);

            if (note === null) return; // User canceled

            if (!confirm(`âš ï¸ ${selectedOrders.size} sipariÅŸin durumunu gÃ¼ncellemek istediÄŸinize emin misiniz?`)) {
                return;
            }

            try {
                const res = await fetch('/api/admin/orders/bulk-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderIds: Array.from(selectedOrders),
                        status: newStatus,
                        note: note || undefined
                    })
                });

                const result = await res.json();

                if (result.success) {
                    alert(`âœ… Toplu gÃ¼ncelleme tamamlandÄ±!\n\nGÃ¼ncellenen: ${result.updated}\nBaÅŸarÄ±sÄ±z: ${result.failed}`);
                    clearSelection();
                    loadOrders();
                } else {
                    alert('âŒ Hata: ' + result.error);
                }
            } catch (error) {
                console.error('Bulk update error:', error);
                alert('âŒ Toplu gÃ¼ncelleme sÄ±rasÄ±nda hata oluÅŸtu: ' + error.message);
            }
        }

        // Load orders on page load
        loadOrders();

        // Auto-refresh every 60 seconds
        setInterval(loadOrders, 60000);
    </script>
</body>

</html>